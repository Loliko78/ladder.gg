{% extends "base.html" %}

{% block title %}–õ–æ–±–±–∏: {{ lobby.name }} - Ladder.gg{% endblock %}

{% block content %}
<div class="container lobby-room">
    <div class="lobby-header">
        <div class="header-info">
            <h1>üéÆ {{ lobby.name }}</h1>
            <div class="lobby-details">
                <span class="detail">üìç {{ lobby.server }}</span>
                <span class="detail">‚öîÔ∏è {{ lobby.mode }}</span>
                <span class="detail">üë• {{ lobby.current_players }}/{{ lobby.max_players }}</span>
                <span class="detail status-{{ lobby.status }}">{{ lobby.status.upper() }}</span>
            </div>
        </div>
        <div class="header-actions">
            <a href="{{ url_for('main.lobbies') }}" class="btn btn-secondary">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è</a>
        </div>
    </div>

    <div class="lobby-content">
        <!-- –õ–ï–í–ê–Ø –ö–û–õ–û–ù–ù–ê: –û–ü–ò–°–ê–ù–ò–ï –ò –ö–ù–û–ü–ö–ò -->
        <div class="lobby-left">
            <!-- –û–ø–∏—Å–∞–Ω–∏–µ –ª–æ–±–±–∏ -->
            <section class="lobby-description">
                <h2>üìù –û–ø–∏—Å–∞–Ω–∏–µ</h2>
                {% if lobby.description %}
                    <p class="description-text">{{ lobby.description }}</p>
                {% else %}
                    <p class="description-text empty">–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç</p>
                {% endif %}
            </section>

            <!-- –ö–Ω–æ–ø–∫–∏ —Å–∫—Ä–∏–Ω—à–æ—Ç–æ–≤ (—Ç–æ–ª—å–∫–æ –¥–ª—è —á–ª–µ–Ω–æ–≤ –ª–æ–±–±–∏) -->
            {% if is_member %}
            <section class="lobby-actions">
                <h2>üì∏ –†–µ–∑—É–ª—å—Ç–∞—Ç –º–∞—Ç—á–∞</h2>
                <p class="action-hint">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É –∞–¥–º–∏–Ω–∞–º</p>
                <div class="action-buttons">
                    <button class="btn btn-success" onclick="submitScreenshot('win')">
                        ‚úì –ú—ã –≤—ã–∏–≥—Ä–∞–ª–∏
                    </button>
                    <button class="btn btn-danger" onclick="submitScreenshot('loss')">
                        ‚úó –ú—ã –ø—Ä–æ–∏–≥—Ä–∞–ª–∏
                    </button>
                </div>
                <input type="file" id="screenshotInput" accept="image/*" style="display: none;">
            </section>
            {% else %}
            <section class="lobby-join-section">
                <h2>–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</h2>
                {% if lobby.status == 'open' %}
                    <button class="btn btn-primary btn-large" onclick="joinCurrentLobby()">
                        –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –ª–æ–±–±–∏
                    </button>
                {% elif lobby.status == 'full' %}
                    <p class="status-message">–õ–æ–±–±–∏ –ø–æ–ª–Ω–æ–µ üòû</p>
                {% elif lobby.status == 'started' %}
                    <p class="status-message">–ú–∞—Ç—á —É–∂–µ –Ω–∞—á–∞–ª—Å—è üéÆ</p>
                {% endif %}
            </section>
            {% endif %}
        </div>

        <!-- –ü–†–ê–í–ê–Ø –ö–û–õ–û–ù–ù–ê: –£–ß–ê–°–¢–ù–ò–ö–ò –ò –ß–ê–¢ -->
        <div class="lobby-right">
            <!-- –°–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ -->
            <section class="lobby-members">
                <div class="members-header">
                    <h2>üë• –£—á–∞—Å—Ç–Ω–∏–∫–∏ ({{ members|length }}/{{ lobby.max_players }})</h2>
                    {% if is_creator %}
                        <button class="btn btn-small btn-secondary" onclick="showInviteModal()">üîó –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å</button>
                    {% endif %}
                </div>
                <div class="members-list">
                    {% for member in members %}
                        <div class="member-item" data-user-id="{{ member.user.id }}">
                            <div class="member-avatar">{{ member.user.username[0]|upper }}</div>
                            <div class="member-info">
                                <div class="member-name">
                                    {{ member.user.username }}
                                    {% if member.user.id == lobby.creator_id %}<span class="badge-creator">–°–æ–∑–¥–∞—Ç–µ–ª—å</span>{% endif %}
                                </div>
                                <div class="member-stats">
                                    <span class="stat">‚≠ê {{ member.user.level }}</span>
                                    <span class="stat">üí∞ {{ member.user.ggp }}</span>
                                </div>
                            </div>
                            {% if is_creator and member.user.id != lobby.creator_id %}
                                <div class="member-actions">
                                    <button class="btn-icon" onclick="swapMember({{ member.user.id }})" title="–ü–æ–º–µ–Ω—è—Ç—å –º–µ—Å—Ç–∞–º–∏">‚áÖ</button>
                                    <button class="btn-icon" onclick="kickMember({{ member.user.id }})" title="–ö–∏–∫–Ω—É—Ç—å">‚úï</button>
                                    <button class="btn-icon btn-danger" onclick="banMember({{ member.user.id }})" title="–ó–∞–±–∞–Ω–∏—Ç—å">üö´</button>
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            </section>

            <!-- –ß–∞—Ç -->
            <section class="lobby-chat">
                <h2>üí¨ –ß–∞—Ç</h2>
                <div class="chat-messages" id="chatMessages">
                    {% for message in messages %}
                        <div class="chat-message">
                            <div class="message-author">{{ message.user.username }}</div>
                            <div class="message-time">{{ message.created_at.strftime('%H:%M') }}</div>
                            <div class="message-text">{{ message.message }}</div>
                        </div>
                    {% endfor %}
                </div>
                
                {% if is_member %}
                <form class="chat-form" id="chatForm" onsubmit="sendMessage(event)">
                    <input type="text" id="messageInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." required>
                    <button type="submit" class="btn btn-small">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                </form>
                {% else %}
                <p class="chat-placeholder">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç–µ—Å—å –∫ –ª–æ–±–±–∏, —á—Ç–æ–±—ã –ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è</p>
                {% endif %}
            </section>
        </div>
    </div>
</div>

<style>
.lobby-room {
    padding: 20px;
}

.lobby-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 20px;
    margin-bottom: 30px;
    padding: 20px;
    background: #2a2a2a;
    border-radius: 8px;
    border: 2px solid #404040;
}

.header-info h1 {
    margin: 0 0 15px 0;
    color: #e0e0e0;
    font-size: 32px;
}

.lobby-details {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
}

.detail {
    background: #1a1a1a;
    padding: 6px 12px;
    border-radius: 4px;
    color: #aaa;
    font-size: 14px;
    border-left: 3px solid #c0272d;
}

.detail.status-open {
    color: #66ff99;
    border-left-color: #66ff99;
}

.detail.status-full {
    color: #ff9966;
    border-left-color: #ff9966;
}

.detail.status-started {
    color: #6699ff;
    border-left-color: #6699ff;
}

.lobby-content {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
}

/* –õ–ï–í–ê–Ø –ö–û–õ–û–ù–ù–ê */
.lobby-left {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.lobby-description {
    background: #2a2a2a;
    padding: 20px;
    border-radius: 8px;
    border: 1px solid #404040;
}

.lobby-description h2 {
    margin: 0 0 15px 0;
    color: #e0e0e0;
    font-size: 18px;
}

.description-text {
    color: #d0d0d0;
    line-height: 1.6;
    margin: 0;
    white-space: pre-wrap;
    word-wrap: break-word;
}

.description-text.empty {
    color: #888;
    font-style: italic;
}

.lobby-actions, .lobby-join-section {
    background: #2a2a2a;
    padding: 20px;
    border-radius: 8px;
    border: 1px solid #404040;
}

.lobby-actions h2, .lobby-join-section h2 {
    margin: 0 0 15px 0;
    color: #e0e0e0;
    font-size: 18px;
}

.action-hint {
    color: #aaa;
    font-size: 13px;
    margin: 0 0 15px 0;
}

.action-buttons {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
}

.btn-success {
    background: #1a5a2a;
    color: #66ff99;
    border: 2px solid #66ff99;
}

.btn-success:hover {
    background: #2a7a3a;
}

.btn-danger {
    background: #5a1a1a;
    color: #ff6666;
    border: 2px solid #ff6666;
}

.btn-danger:hover {
    background: #7a2a2a;
}

.status-message {
    color: #aaa;
    text-align: center;
    padding: 20px;
    font-size: 16px;
}

.btn-large {
    width: 100%;
    padding: 14px;
    font-size: 16px;
}

/* –ü–†–ê–í–ê–Ø –ö–û–õ–û–ù–ù–ê */
.lobby-right {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.lobby-members {
    background: #2a2a2a;
    padding: 20px;
    border-radius: 8px;
    border: 1px solid #404040;
    flex: 0 0 auto;
    max-height: 400px;
    overflow-y: auto;
}

.lobby-members h2 {
    margin: 0 0 15px 0;
    color: #e0e0e0;
    font-size: 18px;
}

.members-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.member-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    background: #1a1a1a;
    border-radius: 6px;
    border: 1px solid #404040;
}

.member-avatar {
    width: 40px;
    height: 40px;
    background: linear-gradient(135deg, #c0272d, #8f1d22);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    flex-shrink: 0;
}

.member-info {
    flex: 1;
}

.member-name {
    color: #e0e0e0;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
}

.badge-creator {
    background: #c0272d;
    color: white;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 11px;
    font-weight: bold;
}

.member-stats {
    display: flex;
    gap: 10px;
    margin-top: 4px;
    font-size: 12px;
    color: #aaa;
}

.stat {
    display: inline-block;
}

.lobby-chat {
    background: #2a2a2a;
    padding: 20px;
    border-radius: 8px;
    border: 1px solid #404040;
    flex: 1;
    display: flex;
    flex-direction: column;
}

.lobby-chat h2 {
    margin: 0 0 15px 0;
    color: #e0e0e0;
    font-size: 18px;
}

.chat-messages {
    flex: 1;
    background: #1a1a1a;
    border: 1px solid #404040;
    border-radius: 6px;
    padding: 15px;
    overflow-y: auto;
    margin-bottom: 12px;
    max-height: 300px;
}

.chat-message {
    margin-bottom: 12px;
    padding-bottom: 12px;
    border-bottom: 1px solid #404040;
}

.chat-message:last-child {
    border-bottom: none;
    margin-bottom: 0;
    padding-bottom: 0;
}

.message-author {
    color: #ff6b6b;
    font-weight: 600;
    font-size: 13px;
}

.message-time {
    color: #888;
    font-size: 11px;
    display: inline-block;
    margin-left: 8px;
}

.message-text {
    color: #d0d0d0;
    margin-top: 4px;
    font-size: 14px;
    line-height: 1.4;
}

.chat-form {
    display: flex;
    gap: 8px;
}

.chat-form input {
    flex: 1;
    padding: 10px;
    background: #1a1a1a;
    color: #e0e0e0;
    border: 1px solid #404040;
    border-radius: 4px;
    font-size: 14px;
}

.chat-form input:focus {
    outline: none;
    border-color: #c0272d;
    box-shadow: 0 0 4px rgba(192, 39, 45, 0.2);
}

.chat-placeholder {
    text-align: center;
    color: #888;
    padding: 20px;
    font-size: 13px;
}

.btn {
    padding: 10px 16px;
    background: #c0272d;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.2s;
    font-size: 14px;
}

.btn:hover {
    background: #8f1d22;
    transform: translateY(-1px);
}

.btn-small {
    padding: 8px 12px;
    font-size: 13px;
}

.btn-secondary {
    background: #2a2a2a;
    color: #d0d0d0;
    border: 1px solid #404040;
}

.btn-secondary:hover {
    background: #3a3a3a;
}

@media (max-width: 1024px) {
    .lobby-content {
        grid-template-columns: 1fr;
    }
    
    .action-buttons {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 768px) {
    .lobby-header {
        flex-direction: column;
    }
    
    .lobby-details {
        flex-direction: column;
    }
}
</style>

<script>
function sendMessage(event) {
    event.preventDefault();
    
    const messageInput = document.getElementById('messageInput');
    const message = messageInput.value.trim();
    
    if (!message) return;
    
    fetch('/api/lobby/{{ lobby.id }}/message', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ message })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            messageInput.value = '';
            // –î–æ–±–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç
            const chatMessages = document.getElementById('chatMessages');
            const msgEl = document.createElement('div');
            msgEl.className = 'chat-message';
            msgEl.innerHTML = `
                <div class="message-author">${data.username}</div>
                <div class="message-time">${new Date().toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'})}</div>
                <div class="message-text">${data.message}</div>
            `;
            chatMessages.appendChild(msgEl);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        } else {
            alert('‚ùå –û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ'));
        }
    })
    .catch(err => alert('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + err.message));
}

function joinCurrentLobby() {
    fetch('/api/lobby/{{ lobby.id }}/join', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ password: null })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('‚ùå –û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è'));
        }
    })
    .catch(err => alert('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + err.message));
}

function submitScreenshot(result) {
    document.getElementById('screenshotInput').click();
    
    document.getElementById('screenshotInput').onchange = function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(event) {
            const base64 = event.target.result.split(',')[1];
            
            // –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–∫—Ä–∏–Ω—à–æ—Ç –Ω–∞ –∞–Ω–∞–ª–∏–∑
            fetch('/api/analyze-screenshot', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    image_base64: base64,
                    result: result,
                    lobby_id: {{ lobby.id }}
                })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    alert('‚úì –°–∫—Ä–∏–Ω—à–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É –∞–¥–º–∏–Ω–∞–º!');
                } else {
                    alert('‚ùå –û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–∫—Ä–∏–Ω—à–æ—Ç'));
                }
            })
            .catch(err => alert('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + err.message));
        };
        reader.readAsDataURL(file);
    };
}

// –ê–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∞ —á–∞—Ç–∞
window.addEventListener('load', function() {
    const chatMessages = document.getElementById('chatMessages');
    if (chatMessages) {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    // Auto-join with invite code if present
    {% if invite_code and not is_member %}
    joinCurrentLobby('{{ invite_code }}');
    {% endif %}
});

// Modal functions
function showModal(modalId) {
    document.getElementById(modalId).style.display = 'flex';
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

function showNotification(message, type = 'success') {
    const notification = document.getElementById('notification');
    const notificationText = document.getElementById('notificationText');
    notificationText.textContent = message;
    notification.className = `notification notification-${type}`;
    notification.style.display = 'block';
    setTimeout(() => {
        notification.style.display = 'none';
    }, 3000);
}

// Lobby management functions
function kickMember(userId) {
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∫–∏–∫–Ω—É—Ç—å —ç—Ç–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞?')) return;
    
    fetch(`/api/lobby/{{ lobby.id }}/kick`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({user_id: userId})
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            showNotification('–£—á–∞—Å—Ç–Ω–∏–∫ –∏—Å–∫–ª—é—á–µ–Ω –∏–∑ –ª–æ–±–±–∏', 'success');
            location.reload();
        } else {
            showNotification(data.error || '–û—à–∏–±–∫–∞', 'error');
        }
    })
    .catch(err => showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + err.message, 'error'));
}

function banMember(userId) {
    showModal('banModal');
    document.getElementById('banUserId').value = userId;
}

function confirmBan() {
    const userId = document.getElementById('banUserId').value;
    const reason = document.getElementById('banReason').value;
    
    fetch(`/api/lobby/{{ lobby.id }}/ban`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({user_id: userId, reason: reason})
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            showNotification('–£—á–∞—Å—Ç–Ω–∏–∫ –∑–∞–±–∞–Ω–µ–Ω –≤ –ª–æ–±–±–∏', 'success');
            closeModal('banModal');
            location.reload();
        } else {
            showNotification(data.error || '–û—à–∏–±–∫–∞', 'error');
        }
    })
    .catch(err => showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + err.message, 'error'));
}

let swapUser1 = null;
function swapMember(userId) {
    if (!swapUser1) {
        swapUser1 = userId;
        showNotification('–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ç–æ—Ä–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞ –¥–ª—è –æ–±–º–µ–Ω–∞ –º–µ—Å—Ç–∞–º–∏', 'info');
        // Highlight selected member
        document.querySelector(`[data-user-id="${userId}"]`).classList.add('selected');
    } else {
        if (swapUser1 === userId) {
            showNotification('–í—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞', 'error');
            return;
        }
        
        fetch(`/api/lobby/{{ lobby.id }}/swap`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({user1_id: swapUser1, user2_id: userId})
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                showNotification('–ú–µ—Å—Ç–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∏–∑–º–µ–Ω–µ–Ω—ã', 'success');
                location.reload();
            } else {
                showNotification(data.error || '–û—à–∏–±–∫–∞', 'error');
            }
        })
        .catch(err => showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + err.message, 'error'));
        
        // Reset selection
        document.querySelector(`[data-user-id="${swapUser1}"]`).classList.remove('selected');
        swapUser1 = null;
    }
}

function showInviteModal() {
    fetch(`/api/lobby/{{ lobby.id }}/invite`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({expires_hours: 24, max_uses: null})
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            document.getElementById('inviteUrl').value = data.invite_url;
            document.getElementById('inviteCode').textContent = data.invite_code;
            showModal('inviteModal');
        } else {
            showNotification(data.error || '–û—à–∏–±–∫–∞', 'error');
        }
    })
    .catch(err => showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + err.message, 'error'));
}

function copyInviteLink() {
    const input = document.getElementById('inviteUrl');
    input.select();
    document.execCommand('copy');
    showNotification('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!', 'success');
}

// Update join function to support invite codes
function joinCurrentLobby(inviteCode = null) {
    const data = {password: null};
    if (inviteCode) {
        data.invite_code = inviteCode;
    }
    
    fetch('/api/lobby/{{ lobby.id }}/join', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            showNotification('–í—ã –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –∫ –ª–æ–±–±–∏!', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showNotification(data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è', 'error');
        }
    })
    .catch(err => showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + err.message, 'error'));
}

// Replace all alerts with notifications
const originalAlert = window.alert;
window.alert = function(message) {
    showNotification(message, 'info');
};

// Update existing functions to use notifications
function sendMessage() {
    const input = document.getElementById('messageInput');
    const message = input.value.trim();
    
    if (!message) return;
    
    fetch('/api/lobby/{{ lobby.id }}/message', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({message: message})
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            input.value = '';
            // Reload messages
            location.reload();
        } else {
            showNotification(data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ', 'error');
        }
    })
    .catch(err => showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + err.message, 'error'));
}

function submitScreenshot(result) {
    document.getElementById('screenshotInput').click();
    
    document.getElementById('screenshotInput').onchange = function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(event) {
            const base64 = event.target.result.split(',')[1];
            
            fetch('/api/analyze-screenshot', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    image_base64: base64,
                    result: result,
                    lobby_id: {{ lobby.id }}
                })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    showNotification('–°–∫—Ä–∏–Ω—à–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É –∞–¥–º–∏–Ω–∞–º!', 'success');
                } else {
                    showNotification(data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–∫—Ä–∏–Ω—à–æ—Ç', 'error');
                }
            })
            .catch(err => showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + err.message, 'error'));
        };
        reader.readAsDataURL(file);
    };
}
</script>

<!-- Modals -->
<div id="banModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2>–ó–∞–±–∞–Ω–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞</h2>
            <span class="modal-close" onclick="closeModal('banModal')">&times;</span>
        </div>
        <div class="modal-body">
            <input type="hidden" id="banUserId">
            <label for="banReason">–ü—Ä–∏—á–∏–Ω–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):</label>
            <textarea id="banReason" rows="3" placeholder="–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –±–∞–Ω–∞..."></textarea>
        </div>
        <div class="modal-footer">
            <button class="btn btn-danger" onclick="confirmBan()">–ó–∞–±–∞–Ω–∏—Ç—å</button>
            <button class="btn btn-secondary" onclick="closeModal('banModal')">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>
</div>

<div id="inviteModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2>–ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –≤ –ª–æ–±–±–∏</h2>
            <span class="modal-close" onclick="closeModal('inviteModal')">&times;</span>
        </div>
        <div class="modal-body">
            <p>–ö–æ–¥ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è: <strong id="inviteCode"></strong></p>
            <label for="inviteUrl">–°—Å—ã–ª–∫–∞ –¥–ª—è –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è:</label>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="inviteUrl" readonly style="flex: 1;">
                <button class="btn btn-primary" onclick="copyInviteLink()">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('inviteModal')">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>
</div>

<!-- Notification -->
<div id="notification" class="notification" style="display: none;">
    <span id="notificationText"></span>
</div>

<style>
.members-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.member-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.member-item.selected {
    background: rgba(33, 150, 243, 0.2);
    border: 2px solid #2196F3;
}

.member-actions {
    display: flex;
    gap: 5px;
}

.btn-icon {
    background: transparent;
    border: 1px solid var(--border-color);
    padding: 5px 10px;
    cursor: pointer;
    border-radius: 4px;
    font-size: 14px;
}

.btn-icon:hover {
    background: var(--hover-bg);
}

.btn-icon.btn-danger {
    color: #f44336;
    border-color: #f44336;
}

.btn-icon.btn-danger:hover {
    background: #f44336;
    color: white;
}

.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    align-items: center;
    justify-content: center;
}

.modal-content {
    background: var(--card-bg);
    border-radius: 8px;
    padding: 20px;
    max-width: 500px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.modal-close {
    font-size: 28px;
    cursor: pointer;
    color: var(--text-secondary);
}

.modal-close:hover {
    color: var(--text-primary);
}

.modal-body {
    margin-bottom: 20px;
}

.modal-footer {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
}

.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 15px 20px;
    border-radius: 8px;
    z-index: 2000;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.notification-success {
    background: #4caf50;
    color: white;
}

.notification-error {
    background: #f44336;
    color: white;
}

.notification-info {
    background: #2196F3;
    color: white;
}
</style>
{% endblock %}
