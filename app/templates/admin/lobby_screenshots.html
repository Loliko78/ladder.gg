{% extends "base.html" %}

{% block title %}–°–∫—Ä–∏–Ω—à–æ—Ç—ã –ª–æ–±–±–∏ - Ladder.gg{% endblock %}

{% block content %}
<div class="container">
    <h1>üì∏ –°–∫—Ä–∏–Ω—à–æ—Ç—ã –∏–∑ –ª–æ–±–±–∏</h1>
    
    <div class="screenshots-filters">
        <a href="{{ url_for('admin.lobby_screenshots', status='all') }}" class="btn {% if status_filter == 'all' %}btn-primary{% else %}btn-secondary{% endif %}">–í—Å–µ</a>
        <a href="{{ url_for('admin.lobby_screenshots', status='pending') }}" class="btn {% if status_filter == 'pending' %}btn-primary{% else %}btn-secondary{% endif %}">–û–∂–∏–¥–∞—é—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏</a>
        <a href="{{ url_for('admin.lobby_screenshots', status='approved') }}" class="btn {% if status_filter == 'approved' %}btn-primary{% else %}btn-secondary{% endif %}">–û–¥–æ–±—Ä–µ–Ω–Ω—ã–µ</a>
        <a href="{{ url_for('admin.lobby_screenshots', status='rejected') }}" class="btn {% if status_filter == 'rejected' %}btn-primary{% else %}btn-secondary{% endif %}">–û—Ç–∫–ª–æ–Ω–µ–Ω–Ω—ã–µ</a>
    </div>

    {% if screenshots.items %}
        <div class="screenshots-grid">
            {% for screenshot in screenshots.items %}
                <div class="screenshot-card" data-id="{{ screenshot.id }}">
                    <div class="screenshot-header">
                        <div class="screenshot-info">
                            <h3>–õ–æ–±–±–∏ #{{ screenshot.lobby_id }}</h3>
                            <p class="screenshot-meta">
                                <span>üë§ {{ screenshot.user.username }}</span>
                                <span>üìÖ {{ screenshot.created_at.strftime('%d.%m.%Y %H:%M') }}</span>
                                <span class="result-badge result-{{ screenshot.result }}">
                                    {% if screenshot.result == 'win' %}‚úì –ü–æ–±–µ–¥–∞{% else %}‚úó –ü–æ—Ä–∞–∂–µ–Ω–∏–µ{% endif %}
                                </span>
                            </p>
                        </div>
                        <div class="screenshot-status">
                            <span class="status-badge status-{{ screenshot.status }}">
                                {% if screenshot.status == 'pending' %}–û–∂–∏–¥–∞–µ—Ç
                                {% elif screenshot.status == 'approved' %}–û–¥–æ–±—Ä–µ–Ω–æ
                                {% else %}–û—Ç–∫–ª–æ–Ω–µ–Ω–æ{% endif %}
                            </span>
                        </div>
                    </div>
                    
                    <div class="screenshot-image">
                        {% set img_path = screenshot.image_path.replace('\\', '/') %}
                        <img src="{{ url_for('static', filename='uploads/' + img_path) }}" 
                             alt="Screenshot" 
                             onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22300%22 height=%22200%22%3E%3Crect fill=%22%232a2a2a%22 width=%22300%22 height=%22200%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 font-family=%22Arial%22 font-size=%2214%22 fill=%22%23e0e0e0%22%3E%D0%9D%D0%B5%D1%82%20%D0%B8%D0%B7%D0%BE%D0%B1%D1%80%D0%B0%D0%B6%D0%B5%D0%BD%D0%B8%D1%8F%3C/text%3E%3C/svg%3E'"
                             onclick="openImageModal(this.src)">
                    </div>
                    
                    {% if screenshot.status == 'pending' %}
                        <div class="screenshot-actions">
                            <button class="btn btn-success" onclick="reviewScreenshot({{ screenshot.id }}, 'approve')">
                                ‚úì –û–¥–æ–±—Ä–∏—Ç—å
                            </button>
                            <button class="btn btn-danger" onclick="reviewScreenshot({{ screenshot.id }}, 'reject')">
                                ‚úó –û—Ç–∫–ª–æ–Ω–∏—Ç—å
                            </button>
                        </div>
                    {% endif %}
                    
                    {% if screenshot.reviewed_by %}
                        <div class="screenshot-review-info">
                            <p><strong>–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ:</strong> {{ screenshot.reviewer.username }}</p>
                            <p><strong>–î–∞—Ç–∞:</strong> {{ screenshot.reviewed_at.strftime('%d.%m.%Y %H:%M') }}</p>
                            {% if screenshot.notes %}
                                <p><strong>–ó–∞–º–µ—Ç–∫–∏:</strong> {{ screenshot.notes }}</p>
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
            {% endfor %}
        </div>
        
        <!-- Pagination -->
        <div class="pagination">
            {% if screenshots.has_prev %}
                <a href="{{ url_for('admin.lobby_screenshots', page=screenshots.prev_num, status=status_filter) }}" class="btn btn-secondary">‚Üê –ù–∞–∑–∞–¥</a>
            {% endif %}
            <span class="page-info">–°—Ç—Ä–∞–Ω–∏—Ü–∞ {{ screenshots.page }} –∏–∑ {{ screenshots.pages }}</span>
            {% if screenshots.has_next %}
                <a href="{{ url_for('admin.lobby_screenshots', page=screenshots.next_num, status=status_filter) }}" class="btn btn-secondary">–í–ø–µ—Ä–µ–¥ ‚Üí</a>
            {% endif %}
        </div>
    {% else %}
        <p class="no-screenshots">–ù–µ—Ç —Å–∫—Ä–∏–Ω—à–æ—Ç–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</p>
    {% endif %}
</div>

<!-- Image Modal -->
<div id="imageModal" class="modal" style="display: none;">
    <div class="modal-content image-modal">
        <span class="modal-close" onclick="closeImageModal()">&times;</span>
        <img id="modalImage" src="" alt="Screenshot">
    </div>
</div>

<!-- Review Modal -->
<div id="reviewModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2>–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞</h2>
            <span class="modal-close" onclick="closeReviewModal()">&times;</span>
        </div>
        <div class="modal-body">
            <label for="reviewNotes">–ó–∞–º–µ—Ç–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):</label>
            <textarea id="reviewNotes" rows="4" placeholder="–î–æ–±–∞–≤—å—Ç–µ –∑–∞–º–µ—Ç–∫–∏ –æ –ø—Ä–æ–≤–µ—Ä–∫–µ..."></textarea>
        </div>
        <div class="modal-footer">
            <button id="confirmReviewBtn" class="btn btn-primary">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
            <button class="btn btn-secondary" onclick="closeReviewModal()">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>
</div>

<style>
.screenshots-filters {
    margin: 20px 0;
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.screenshots-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
    gap: 20px;
    margin: 20px 0;
}

.screenshot-card {
    background: var(--card-bg);
    border-radius: 8px;
    padding: 15px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.screenshot-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: 15px;
}

.screenshot-info h3 {
    margin: 0 0 5px 0;
    font-size: 1.1em;
}

.screenshot-meta {
    display: flex;
    flex-direction: column;
    gap: 5px;
    font-size: 0.9em;
    color: var(--text-secondary);
}

.result-badge {
    display: inline-block;
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 0.85em;
    font-weight: bold;
}

.result-win {
    background: #4caf50;
    color: white;
}

.result-loss {
    background: #f44336;
    color: white;
}

.status-badge {
    padding: 5px 10px;
    border-radius: 4px;
    font-size: 0.85em;
    font-weight: bold;
}

.status-pending {
    background: #ff9800;
    color: white;
}

.status-approved {
    background: #4caf50;
    color: white;
}

.status-rejected {
    background: #f44336;
    color: white;
}

.screenshot-image {
    margin: 15px 0;
    cursor: pointer;
    border-radius: 4px;
    overflow: hidden;
}

.screenshot-image img {
    width: 100%;
    height: auto;
    display: block;
    transition: transform 0.3s;
}

.screenshot-image img:hover {
    transform: scale(1.05);
}

.screenshot-actions {
    display: flex;
    gap: 10px;
    margin-top: 15px;
}

.screenshot-review-info {
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid var(--border-color);
    font-size: 0.9em;
    color: var(--text-secondary);
}

.screenshot-review-info p {
    margin: 5px 0;
}

.image-modal {
    max-width: 90vw;
    max-height: 90vh;
    background: transparent;
}

.image-modal img {
    max-width: 100%;
    max-height: 90vh;
    object-fit: contain;
}

.no-screenshots {
    text-align: center;
    padding: 40px;
    color: var(--text-secondary);
    font-size: 1.1em;
}

.pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 15px;
    margin: 30px 0;
}

.page-info {
    color: var(--text-secondary);
}
</style>

<script>
let currentScreenshotId = null;
let currentAction = null;

function openImageModal(src) {
    document.getElementById('modalImage').src = src;
    document.getElementById('imageModal').style.display = 'flex';
}

function closeImageModal() {
    document.getElementById('imageModal').style.display = 'none';
}

function reviewScreenshot(screenshotId, action) {
    currentScreenshotId = screenshotId;
    currentAction = action;
    document.getElementById('reviewNotes').value = '';
    document.getElementById('reviewModal').style.display = 'flex';
}

function closeReviewModal() {
    document.getElementById('reviewModal').style.display = 'none';
    currentScreenshotId = null;
    currentAction = null;
}

document.getElementById('confirmReviewBtn').addEventListener('click', function() {
    if (!currentScreenshotId || !currentAction) return;
    
    const notes = document.getElementById('reviewNotes').value;
    
    fetch(`/admin/lobby-screenshots/${currentScreenshotId}/review`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            action: currentAction,
            notes: notes
        })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∑–∞–ø—Ä–æ—Å'));
        }
    })
    .catch(err => {
        alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + err.message);
    });
});

// Close modals on outside click
window.onclick = function(event) {
    const imageModal = document.getElementById('imageModal');
    const reviewModal = document.getElementById('reviewModal');
    
    if (event.target == imageModal) {
        closeImageModal();
    }
    if (event.target == reviewModal) {
        closeReviewModal();
    }
}
</script>
{% endblock %}

